# 🚀 コスト最適化 & OCR精度向上 - v1.1

## 🎯 目標

品質を落とさずにシステム運用コストを削減し、レシートOCR精度を最大化する

## 📊 現在の課題

### 💰 コスト課題
- Google Cloud Vision API: レシート1枚あたり$0.0015
- Firebase Functions: 長時間実行による課金
- Firestore: 不要な読み書き操作
- 画像処理: 最適化されていない画像での処理

### 🔍 OCR精度課題  
- レシート画像の品質による認識率低下
- 日本語レシート特有のレイアウト対応不足
- 金額・店舗名の抽出精度のばらつき
- エラー時の再処理機能なし

## 🛠️ 解決策

### 1. コスト最適化
- [ ] **画像前処理最適化**: 画質向上→API精度向上→再処理回数削減
- [ ] **Cloud Functions メモリ最適化**: 256MB→128MBで十分な処理に調整
- [ ] **Firestore クエリ最適化**: 複合インデックス・ページネーション
- [ ] **キャッシュ戦略**: よく使用される画像パターンのローカルキャッシュ
- [ ] **バッチ処理**: 複数画像の一括処理による API call 削減

### 2. OCR精度向上
- [ ] **前処理エンジン**: 画像補正・ノイズ除去・コントラスト調整
- [ ] **Vision API 設定最適化**: 日本語特化パラメータ調整
- [ ] **後処理ロジック強化**: 正規表現・パターンマッチング改善
- [ ] **フォールバック機能**: 失敗時の段階的再処理
- [ ] **信頼度スコア**: OCR結果の確信度による処理分岐

### 3. 品質担保
- [ ] **A/Bテスト**: 改善前後の精度比較
- [ ] **メトリクス収集**: 成功率・処理時間・コスト監視
- [ ] **ユーザーフィードバック**: 修正機能による学習データ蓄積

## 📈 期待効果

### コスト削減
- Vision API コスト: **30-50%削減** (再処理回数減少)
- Functions 実行コスト: **20-30%削減** (メモリ最適化)
- Firestore コスト: **40-60%削減** (クエリ最適化)

### 精度向上
- OCR成功率: **現在60-70% → 目標85-90%**
- 金額認識精度: **現在70-80% → 目標90-95%**
- ユーザー満足度向上

## 🏗️ 実装計画

### Phase 1: 画像前処理最適化 (優先度: High)
```typescript
// 新機能
- imageOptimizer.ts: 画像品質向上
- enhancedParser.ts: 改良版パーサー
- costOptimizer.ts: コスト監視
```

### Phase 2: Vision API最適化 (優先度: High)  
```typescript
// 改善項目
- 日本語特化設定
- 信頼度しきい値調整
- フォールバック処理
```

### Phase 3: 後処理強化 (優先度: Medium)
```typescript
// 機能追加
- 正規表現パターン拡張
- 学習機能追加
- エラー分析
```

## 🔍 テスト戦略

### 定量評価
- [ ] 100枚のテストレシートで Before/After 比較
- [ ] レスポンス時間計測
- [ ] コスト使用量監視

### 定性評価  
- [ ] ユーザーフィードバック収集
- [ ] エラーケース分析
- [ ] 使いやすさ向上

## ⚡ アクションアイテム

1. **imageOptimizer.ts**: 画像前処理ライブラリ実装
2. **enhancedParser.ts**: 改良版レシート解析ロジック 
3. **コスト監視**: Cloud Monitoring ダッシュボード設定
4. **A/Bテスト環境**: 新旧比較テスト実装
5. **ドキュメント更新**: 最適化ガイド作成

## 📋 成功指標

- [ ] OCR精度: 85%以上
- [ ] 月間コスト: 30%削減
- [ ] 処理時間: 5秒以内
- [ ] ユーザー満足度: 4.5/5.0以上

---

**関連ファイル**: 
- `bot/src/parser.ts` (既存)
- `bot/src/index.ts` (画像処理部分)
- `firestore.rules` (クエリ最適化)

**担当**: @makoto041s
**期限**: 2025年9月末
**優先度**: High
